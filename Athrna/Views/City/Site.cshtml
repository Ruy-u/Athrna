@model Athrna.Models.Site

@{
    ViewData["Title"] = Model.Name;
}

<div class="site-hero">
    <div class="site-overlay"></div>
    @if (!string.IsNullOrEmpty(Model.ImagePath))
    {
        <img src="@Model.ImagePath" alt="@Model.Name" class="site-hero-img">
    }
    else
    {
        <img src="/api/placeholder/1200/400" alt="@Model.Name" class="site-hero-img">
    }
    <div class="container">
        <h1 class="site-title">@Model.Name</h1>
        <div class="site-meta">
            <span class="site-type">@Model.SiteType</span>
            <span class="site-location">
                <i class="bi bi-geo-alt"></i> @Model.Location
            </span>
            @if (Model.CulturalInfo != null)
            {
                <span class="site-year">
                    <i class="bi bi-calendar"></i> Established: @Model.CulturalInfo.EstablishedDate
                </span>
            }
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Site Description -->
            <section class="site-description-section">
                <h2>About @Model.Name</h2>
                <p>@Model.Description</p>

                @if (Model.CulturalInfo != null)
                {
                    <h3 class="mt-4">Cultural Information</h3>
                    <p>@Model.CulturalInfo.Summary</p>
                }
            </section>

            <!-- Public Services Section -->
            <section class="site-description-section mt-5">
                <h2>Available Services</h2>
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-p-circle-fill"></i>
                            </div>
                            <div class="service-details">
                                <h4>Parking</h4>
                                <p>Free parking available for visitors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-info-circle-fill"></i>
                            </div>
                            <div class="service-details">
                                <h4>Information Center</h4>
                                <p>Tourist information and guides</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-cup-hot-fill"></i>
                            </div>
                            <div class="service-details">
                                <h4>Café</h4>
                                <p>Traditional Saudi coffee and refreshments</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-shop"></i>
                            </div>
                            <div class="service-details">
                                <h4>Gift Shop</h4>
                                <p>Local crafts and souvenirs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-wifi"></i>
                            </div>
                            <div class="service-details">
                                <h4>Free Wi-Fi</h4>
                                <p>Available throughout the site</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="service-item">
                            <div class="service-icon">
                                <i class="bi bi-universal-access"></i>
                            </div>
                            <div class="service-details">
                                <h4>Accessibility</h4>
                                <p>Wheelchair ramps and accessible facilities</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Available Guides Section -->
            <section class="site-description-section mt-5">
                <h2>Available Guides</h2>
                <div class="row mt-4">
                    @{
                        // Get guides for this city from ViewBag or create sample ones
                        var guides = ViewBag.Guides as List<Athrna.Models.Guide> ?? new List<Athrna.Models.Guide>();

                        // If guides is empty, get from the site's city
                        if (!guides.Any() && Model.City != null && Model.City.Guides != null)
                        {
                            guides = Model.City.Guides.ToList();
                        }
                    }

                    @if (guides.Any())
                    {
                        foreach (var guide in guides.Take(3))
                        {
                            <div class="col-md-12 mb-4">
                                <div class="guide-profile">
                                    <div class="guide-avatar">
                                        <div class="avatar-circle">
                                            @(guide.FullName.Substring(0, 1).ToUpper())
                                        </div>
                                    </div>
                                    <div class="guide-info">
                                        <h4>@guide.FullName</h4>
                                        <p class="guide-details">
                                            <i class="bi bi-geo-alt"></i> @guide.City.Name
                                        </p>
                                        <p class="guide-details">
                                            <i class="bi bi-envelope"></i> @guide.Email
                                        </p>
                                        <div class="guide-action">
                                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#guideContactModal" data-guide-name="@guide.FullName" data-guide-email="@guide.Email">
                                                Contact Guide
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="alert alert-info">
                                <p>No guides are currently registered for this location. For guided tours, please check at the information desk on-site.</p>
                            </div>
                        </div>
                    }
                </div>
            </section>

            <!-- Ratings and Reviews -->
            <section class="site-description-section mt-5">
                <h2>Visitor Reviews</h2>

                @if (Model.Ratings != null && Model.Ratings.Any())
                {
                    <div class="rating-summary mt-4">
                        <div class="average-rating">
                            <span class="rating-value">@Model.Ratings.Average(r => r.Value).ToString("0.0")</span>
                            <div class="stars">
                                @{
                                    var averageRating = Model.Ratings.Average(r => r.Value);
                                    for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Floor(averageRating))
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                        else if (i <= Math.Ceiling(averageRating) && averageRating % 1 != 0)
                                        {
                                            <i class="bi bi-star-half"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star"></i>
                                        }
                                    }
                                }
                            </div>
                            <span class="rating-count">@Model.Ratings.Count() reviews</span>
                        </div>

                        <div class="rating-distribution">
                            @for (int i = 5; i >= 1; i--)
                            {
                                var count = Model.Ratings.Count(r => r.Value == i);
                                var percent = Model.Ratings.Any() ? (count * 100 / Model.Ratings.Count()) : 0;

                                <div class="rating-bar">
                                    <div class="rating-label">@i <i class="bi bi-star-fill"></i></div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: @percent%;"
                                             aria-valuenow="@percent" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="rating-count">@count</div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="reviews-list mt-4">
                        @foreach (var rating in Model.Ratings.OrderByDescending(r => r.Id).Take(5))
                        {
                            <div class="review-item">
                                <div class="review-header">
                                    <div class="review-stars">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= rating.Value)
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                    </div>
                                    <div class="reviewer-name">
                                        @(rating.Client?.Username ?? "Anonymous")
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(rating.Review))
                                {
                                    <div class="review-text">
                                        @rating.Review
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="no-reviews">
                        <p>This site doesn't have any reviews yet. Be the first to leave a review!</p>
                    </div>
                }

                @if (User.Identity.IsAuthenticated)
                {
                    <div class="submit-review-section mt-4">
                        <h4>Leave Your Review</h4>
                        <form asp-action="Rate" method="post">
                            <input type="hidden" name="siteId" value="@Model.Id" />

                            <div class="rating-input mb-3">
                                <div class="rating-stars">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        <input type="radio" id="star@(i)" name="value" value="@i" />
                                        <label for="star@(i)" title="@i stars"></label>
                                    }
                                </div>
                                <div class="rating-label">Select your rating</div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="review">Your Review (optional)</label>
                                <textarea id="review" name="review" class="form-control" rows="4" placeholder="Share your experience..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                }
                else
                {
                    <div class="login-prompt mt-4">
                        <p>Please <a asp-controller="Account" asp-action="Login">login</a> to leave a review.</p>
                    </div>
                }
            </section>
        </div>

        <div class="col-lg-4">
            <div class="site-sidebar">
                <!-- Bookmark Button -->
                <div class="sidebar-widget">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <form asp-action="Bookmark" method="post">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-primary btn-block">
                                <i class="bi bi-bookmark"></i> Bookmark this Site
                            </button>
                        </form>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="btn btn-outline-primary btn-block">
                            <i class="bi bi-bookmark"></i> Login to Bookmark
                        </a>
                    }
                </div>

                <!-- Opening Hours -->
                <div class="sidebar-widget">
                    <h4>Opening Hours</h4>
                    <ul class="hours-list">
                        <li><span>Sunday - Thursday:</span> <span>9:00 AM - 5:00 PM</span></li>
                        <li><span>Friday:</span> <span>2:00 PM - 5:00 PM</span></li>
                        <li><span>Saturday:</span> <span>9:00 AM - 5:00 PM</span></li>
                    </ul>
                </div>

                <!-- Admission Fees -->
                <div class="sidebar-widget">
                    <h4>Admission Fees</h4>
                    <ul class="fees-list">
                        <li><span>Adults:</span> <span>50 SAR</span></li>
                        <li><span>Children (under 12):</span> <span>25 SAR</span></li>
                        <li><span>Students:</span> <span>35 SAR</span></li>
                        <li><span>Seniors (65+):</span> <span>35 SAR</span></li>
                        <li><span>Saudi Nationals:</span> <span>Free</span></li>
                    </ul>
                </div>

                <!-- City Information -->
                <div class="sidebar-widget">
                    <h4>Located in</h4>
                    <div class="city-card">
                        <img src="/images/Maps/@(Model.City.Name.ToLower()).jpg" alt="@Model.City.Name" class="city-img" onerror="this.onerror=null; this.src='/api/placeholder/300/150';">
                        <div class="city-info">
                            <h5>@Model.City.Name</h5>
                            <a asp-action="Explore" asp-route-id="@Model.City.Name.ToLower()" class="btn btn-sm btn-primary">Explore @Model.City.Name</a>
                        </div>
                    </div>
                </div>

                <!-- Nearby Sites -->
                <div class="sidebar-widget">
                    <h4>Nearby Sites</h4>
                    <ul class="nearby-sites">
                        @if (ViewBag.NearbySites != null)
                        {
                            foreach (var site in ViewBag.NearbySites)
                            {
                                <li>
                                    <a asp-action="Site" asp-route-id="@site.Id">@site.Name</a>
                                    <span class="site-type-badge">@site.SiteType</span>
                                </li>
                            }
                        }
                        else
                        {
                            <li>No nearby sites found.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Guide Contact Modal -->
<div class="modal fade" id="guideContactModal" tabindex="-1" aria-labelledby="guideContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guideContactModalLabel">Contact Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="guideContactForm">
                    <input type="hidden" id="guideEmail" name="guideEmail" value="">
                    <div class="mb-3">
                        <label for="visitorName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="visitorName" name="visitorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="visitorEmail" class="form-label">Your Email</label>
                        <input type="email" class="form-control" id="visitorEmail" name="visitorEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="visitDate" class="form-label">Preferred Visit Date</label>
                        <input type="date" class="form-control" id="visitDate" name="visitDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="groupSize" class="form-label">Group Size</label>
                        <select class="form-select" id="groupSize" name="groupSize" required>
                            <option value="">Select...</option>
                            <option value="1-2">1-2 people</option>
                            <option value="3-5">3-5 people</option>
                            <option value="6-10">6-10 people</option>
                            <option value="10+">More than 10 people</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendContactMessage">Send Message</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .site-hero {
            position: relative;
            height: 400px;
            background-image: url('/api/placeholder/1200/400');
            background-size: cover;
            background-position: center;
            color: white;
            display: flex;
            align-items: flex-end;
        }

        .site-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.7));
            z-index: 1;
        }

        .site-hero .container {
            position: relative;
            z-index: 2;
            padding-bottom: 2rem;
        }

        .site-title {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .site-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 1rem;
        }

        .site-type {
            background-color: #1a3b29;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
        }

        .site-description-section {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .service-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .service-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .service-icon {
            font-size: 2rem;
            color: #1a3b29;
            margin-right: 1rem;
            min-width: 50px;
            text-align: center;
        }

        .service-details h4 {
            margin: 0;
            color: #1a3b29;
            font-size: 1.2rem;
        }

        .service-details p {
            margin: 0.25rem 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .guide-profile {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .guide-profile:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .guide-avatar {
            margin-right: 1.5rem;
        }

        .avatar-circle {
            width: 80px;
            height: 80px;
            background-color: #1a3b29;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
        }

        .guide-info {
            flex: 1;
        }

            .guide-info h4 {
                margin: 0 0 0.5rem;
                color: #1a3b29;
            }

        .guide-details {
            margin: 0.25rem 0;
            color: #6c757d;
        }

        .guide-action {
            margin-top: 1rem;
        }

        .rating-summary {
            display: flex;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .average-rating {
            text-align: center;
            padding-right: 1.5rem;
            margin-right: 1.5rem;
            border-right: 1px solid #dee2e6;
            min-width: 120px;
        }

        .rating-value {
            font-size: 3rem;
            font-weight: bold;
            color: #1a3b29;
        }

        .stars {
            color: #f8c15c;
            font-size: 1.5rem;
            margin: 0.5rem 0;
        }

        .rating-count {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .rating-distribution {
            flex: 1;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rating-label {
            min-width: 60px;
            color: #6c757d;
        }

        .progress {
            flex: 1;
            height: 8px;
            margin: 0 0.75rem;
        }

        .review-item {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }

            .review-item:last-child {
                border-bottom: none;
            }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .review-stars {
            color: #f8c15c;
        }

        .reviewer-name {
            font-weight: bold;
        }

        .review-text {
            color: #555;
        }

        .rating-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rating-stars {
            display: inline-block;
            direction: rtl;
        }

            .rating-stars input {
                display: none;
            }

            .rating-stars label {
                float: right;
                cursor: pointer;
                color: #ccc;
                font-size: 2rem;
            }

                .rating-stars label:before {
                    content: '★';
                }

                .rating-stars input:checked ~ label,
                .rating-stars label:hover,
                .rating-stars label:hover ~ label {
                    color: #f8c15c;
                }

        .site-sidebar {
            position: sticky;
            top: 2rem;
        }

        .sidebar-widget {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .city-card {
            display: flex;
            flex-direction: column;
        }

        .city-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .city-info {
            text-align: center;
        }

        .nearby-sites, .hours-list, .fees-list {
            list-style: none;
            padding: 0;
        }

            .nearby-sites li, .hours-list li, .fees-list li {
                padding: 0.75rem 0;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

                .nearby-sites li:last-child, .hours-list li:last-child, .fees-list li:last-child {
                    border-bottom: none;
                }

        .site-type-badge {
            background-color: #e9f5ef;
            color: #1a3b29;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }

        .btn-block {
            width: 100%;
        }

        .site-hero-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

      @@media (max-width: 768px) {
            .site-title

        {
            font-size: 2rem;
        }

        .site-meta {
            flex-direction: column;
            gap: 0.5rem;
        }

        .rating-summary {
            flex-direction: column;
        }

        .average-rating {
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            padding-right: 0;
            padding-bottom: 1.5rem;
            margin-right: 0;
            margin-bottom: 1.5rem;
        }

        .site-sidebar {
            position: static;
            margin-top: 2rem;
        }

        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle guide contact modal
            const guideContactModal = document.getElementById('guideContactModal');
            if (guideContactModal) {
                guideContactModal.addEventListener('show.bs.modal', function (event) {
                    // Button that triggered the modal
                    const button = event.relatedTarget;

                    // Extract info from data-* attributes
                    const guideName = button.getAttribute('data-guide-name');
                    const guideEmail = button.getAttribute('data-guide-email');

                    // Update the modal's content
                    const modalTitle = guideContactModal.querySelector('.modal-title');
                    const guidEmailInput = document.getElementById('guideEmail');

                    modalTitle.textContent = `Contact ${guideName}`;
                    guidEmailInput.value = guideEmail;
                });
            }

            // Handle send message button
            const sendMessageBtn = document.getElementById('sendContactMessage');
            if (sendMessageBtn) {
                sendMessageBtn.addEventListener('click', function() {
                    const form = document.getElementById('guideContactForm');

                    // Simple validation
                    if (form.checkValidity()) {
                        // In a real app, you would send the form data to the server
                        // For demo, just show success message
                        alert('Your message has been sent to the guide. They will contact you shortly.');

                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(guideContactModal);
                        modal.hide();
                    } else {
                        form.reportValidity();
                    }
                });
            }

            // Show message if present
        @if (TempData["Message"] != null)
        {
            <text>
                        alert('@TempData["Message"]');
            </text>
        }
        });
    </script>
}